<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regular OMR Practice</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap');
      
      body {
        font-family: 'Raleway', sans-serif;
        font-variant-numeric: tabular-nums;
        transition: background-color 0.3s ease, color 0.3s ease;
        background-color: var(--bg-page);
        color: var(--text-main);
      }

      /* --- THEME VARIABLES --- */
      :root {
        /* Light Theme Defaults */
        --color-cornsilk: #fefae0;
        --color-papaya-whip: #faedcd;
        --color-beige: #e9edc9;
        --color-buff: #d4a373;
        --color-tea-green: #ccd5ae;
        
        --bg-page: var(--color-cornsilk);
        --bg-card: var(--color-papaya-whip);
        --bg-element: var(--color-beige);
        --bg-element-alt: var(--color-cornsilk);
        
        --text-main: #333333;
        --text-subtle: #6b7280;
        --text-inverse: #ffffff;
        
        --border-color: var(--color-tea-green);
        
        --accent-primary: var(--color-buff);
        
        /* Review States (Light Mode) */
        --bg-correct: #86efac; /* Green-300 */
        --bg-wrong: #fca5a5;   /* Red-300 */
        --text-on-state: #064e3b; /* Dark green text for contrast on green, etc */
        
        --omr-stroke: #555;
        --omr-fill: var(--color-buff);
        --timer-fill: var(--color-buff);
        --timer-bg: var(--color-tea-green);
      }

      [data-theme="dark"] {
        --bg-page: #121212;
        --bg-card: #1e1e1e;
        --bg-element: #2d2d2d;
        --bg-element-alt: #262626;
        
        --text-main: #ffffff;
        --text-subtle: #a3a3a3;
        --text-inverse: #000000;
        
        --border-color: #4b5563;
        
        --accent-primary: #e5e5e5;
        
        /* Review States (Dark Mode) */
        --bg-correct: #14532d; /* Green-900 */
        --bg-wrong: #7f1d1d;   /* Red-900 */
        --text-on-state: #ffffff;
        
        --omr-stroke: #aaa;
        --omr-fill: #e5e5e5;
        --timer-fill: #ffffff;
        --timer-bg: #2d2d2d;
      }

      /* Draggable Timer */
      .draggable-timer {
          position: fixed;
          top: 20px;
          right: 20px;
          cursor: grab;
          z-index: 50;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
      }
      .draggable-timer.dragging { cursor: grabbing; }
      
      .timer-text { 
          color: white;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
      }
      [data-theme="dark"] .timer-text { 
          color: #000000; 
          text-shadow: none; 
      }

      /* Accessibility Menu */
      .access-btn {
        position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
        border-radius: 50%; background-color: var(--accent-primary); color: var(--text-inverse);
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000;
        transition: transform 0.2s, background-color 0.3s;
      }
      [data-theme="dark"] .access-btn { color: #000000; }
      .access-btn:hover { transform: scale(1.1); }

      .access-menu {
        position: fixed; bottom: 100px; right: 30px; background-color: var(--bg-card);
        border: 1px solid var(--border-color); border-radius: 15px; padding: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 10px;
        z-index: 999; opacity: 0; pointer-events: none; transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s; min-width: 200px;
      }
      .access-menu.open { opacity: 1; pointer-events: auto; transform: translateY(0); }
      .access-item { display: flex; align-items: center; justify-content: space-between; color: var(--text-main); padding: 8px; cursor: pointer; border-radius: 8px; }
      .access-item:hover { background-color: var(--bg-element); }

      /* Toggle Switch */
      .toggle-switch { position: relative; width: 50px; height: 26px; }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
      .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: var(--accent-primary); }
      input:checked + .slider:before { transform: translateX(24px); }
      [data-theme="dark"] input:checked + .slider { background-color: #ffffff; }
      [data-theme="dark"] input:checked + .slider:before { background-color: #000000; }

      /* OMR Styles */
      .omr-container {
          display: flex;
          gap: 1.5rem;
          align-items: center;
          justify-content: center;
          margin-top: 1rem;
      }
      .omr-bubble {
          width: 45px;
          height: 45px;
          border-radius: 50%;
          border: 2px solid var(--omr-stroke);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 1.1rem;
          cursor: pointer;
          transition: all 0.2s ease;
          background-color: transparent;
          color: var(--text-main);
      }
      .omr-bubble:hover {
          transform: scale(1.1);
          border-color: var(--accent-primary);
      }
      .omr-bubble.selected {
          background-color: var(--omr-fill);
          color: var(--text-inverse);
          border-color: var(--omr-fill);
          box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); 
      }
      [data-theme="dark"] .omr-bubble.selected {
          color: #000000;
      }

      /* Modal/Message Box */
      .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); }
      .modal-content { background-color: var(--bg-card); color: var(--text-main); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconSettings = () => (<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
        const IconMoon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>);
        const IconSun = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>);
        const IconCheck = () => (<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>);
        const IconCross = () => (<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);

        const App = () => {
            // --- State ---
            const [currentScreen, setCurrentScreen] = useState('welcome');
            const [isWelcomeFadingOut, setIsWelcomeFadingOut] = useState(false);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [theme, setTheme] = useState(() => {
                try { return localStorage.getItem('appTheme') || 'light'; } catch (e) { return 'light'; }
            });

            // Session Configuration
            const [sessionName, setSessionName] = useState('');
            const [numQuestions, setNumQuestions] = useState('10');
            const [questionType, setQuestionType] = useState('mcq');
            const [positiveMarks, setPositiveMarks] = useState(4);
            const [negativeMarks, setNegativeMarks] = useState(1);

            // Practice Data
            const [answers, setAnswers] = useState({});
            const [reviewStatus, setReviewStatus] = useState({}); // 'correct', 'wrong', 'unmarked'
            const [reviewNotes, setReviewNotes] = useState({});
            const [totalScore, setTotalScore] = useState(null); 

            // Timer
            const [timerMinutesInput, setTimerMinutesInput] = useState('180');
            const [configuredDurationSeconds, setConfiguredDurationSeconds] = useState(180 * 60);
            const [timeLeftSeconds, setTimeLeftSeconds] = useState(180 * 60);
            const [isRunning, setIsRunning] = useState(false);

            // Refs for timer/drag
            const timerIntervalRef = useRef(null);
            const timerRef = useRef(null);
            const isDragging = useRef(false);
            const offset = useRef({ x: 0, y: 0 });
            const clickStartPos = useRef({ x: 0, y: 0 });

            // --- Effects ---
            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                try { localStorage.setItem('appTheme', theme); } catch(e) {}
            }, [theme]);

            useEffect(() => {
                if (isRunning && timeLeftSeconds > 0) {
                    timerIntervalRef.current = setInterval(() => {
                        setTimeLeftSeconds(prev => prev - 1);
                    }, 1000);
                } else if (timeLeftSeconds === 0 && isRunning) {
                    clearInterval(timerIntervalRef.current);
                    setIsRunning(false);
                    setTimeout(() => { handleSubmitForReview(); }, 500);
                }
                return () => clearInterval(timerIntervalRef.current);
            }, [isRunning, timeLeftSeconds]);

            useEffect(() => {
                const onMove = (e) => handleMouseMove(e);
                const onUp = (e) => handleMouseUp(e);
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
                return () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };
            }, []);

            // --- Handlers ---
            const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');

            // Timer Dragging
            const handleMouseDown = (e) => {
                if (!timerRef.current) return;
                isDragging.current = true;
                timerRef.current.classList.add('dragging');
                offset.current = { x: e.clientX - timerRef.current.getBoundingClientRect().left, y: e.clientY - timerRef.current.getBoundingClientRect().top };
                clickStartPos.current = { x: e.clientX, y: e.clientY };
            };
            const handleMouseMove = (e) => {
                if (!isDragging.current || !timerRef.current) return;
                let newLeft = e.clientX - offset.current.x;
                let newTop = e.clientY - offset.current.y;
                const maxX = window.innerWidth - timerRef.current.offsetWidth;
                const maxY = window.innerHeight - timerRef.current.offsetHeight;
                timerRef.current.style.left = `${Math.max(0, Math.min(newLeft, maxX))}px`;
                timerRef.current.style.top = `${Math.max(0, Math.min(newTop, maxY))}px`;
            };
            const handleMouseUp = (e) => {
                if (!timerRef.current) return;
                isDragging.current = false;
                timerRef.current.classList.remove('dragging');
                if (Math.abs(e.clientX - clickStartPos.current.x) < 5 && Math.abs(e.clientY - clickStartPos.current.y) < 5) {
                    if (timeLeftSeconds === 0) {
                         showMessageBox("Time has run out."); 
                         setIsRunning(false);
                    } else {
                        setIsRunning(prev => !prev);
                    }
                }
            };

            // Logic
            const handleSetTimer = () => {
                const minutes = parseInt(timerMinutesInput, 10);
                if (isNaN(minutes) || minutes <= 0) { showMessageBox("Invalid minutes."); return; }
                const totalSeconds = minutes * 60;
                setConfiguredDurationSeconds(totalSeconds);
                setTimeLeftSeconds(totalSeconds);
                setIsRunning(false);
            };

            const startPractice = () => {
                const parsedNumQuestions = parseInt(numQuestions, 10);
                if (!sessionName.trim()) {
                    showMessageBox("Please enter a Session Name.");
                    return;
                }
                if (isNaN(parsedNumQuestions) || parsedNumQuestions <= 0 || parsedNumQuestions > 180) {
                    showMessageBox("Invalid number of questions (1-180).");
                    return;
                }
                setTimeLeftSeconds(configuredDurationSeconds);
                setIsRunning(true);
                const initialAnswers = {};
                for (let i = 1; i <= parsedNumQuestions; i++) {
                    initialAnswers[i] = questionType === 'mcq' ? [] : '';
                }
                setAnswers(initialAnswers);
                setTotalScore(null); // Reset score
                setCurrentScreen('practice');
            };

            const handleAnswerChange = (qNum, value, isCheckbox = false) => {
                if (isCheckbox) {
                    setAnswers(prev => {
                        const current = prev[qNum] || [];
                        const next = current.includes(value) ? current.filter(i => i !== value) : [...current, value];
                        return { ...prev, [qNum]: next };
                    });
                } else {
                    setAnswers(prev => ({ ...prev, [qNum]: value }));
                }
            };

            const handleSubmitForReview = () => {
                clearInterval(timerIntervalRef.current);
                setIsRunning(false);
                const parsedNumQuestions = parseInt(numQuestions, 10);
                const initialStatus = {};
                const initialNotes = {};
                for (let i = 1; i <= parsedNumQuestions; i++) {
                    initialStatus[i] = 'unmarked';
                    initialNotes[i] = '';
                }
                setReviewStatus(initialStatus);
                setReviewNotes(initialNotes);
                setCurrentScreen('review');
                showMessageBox("Session Ended. Time to review! üìù");
            };

            const handleCalculateScore = () => {
                const parsedNumQuestions = parseInt(numQuestions, 10);
                let score = 0;
                let correctCount = 0;
                let wrongCount = 0;
                
                for (let i = 1; i <= parsedNumQuestions; i++) {
                    if (reviewStatus[i] === 'correct') {
                        score += parseInt(positiveMarks, 10);
                        correctCount++;
                    }
                    else if (reviewStatus[i] === 'wrong') {
                        score -= parseInt(negativeMarks, 10);
                        wrongCount++;
                    }
                }
                setTotalScore(score);
                return { score, correctCount, wrongCount };
            };

            const handleResetAll = () => {
                setSessionName('');
                setNumQuestions('10');
                setQuestionType('mcq');
                setAnswers({});
                setReviewStatus({});
                setTotalScore(null);
                setCurrentScreen('config');
                clearInterval(timerIntervalRef.current);
                setTimeLeftSeconds(configuredDurationSeconds);
                setIsRunning(false);
            };

            // PDF Generation
            const downloadReportCard = () => {
                const { score, correctCount, wrongCount } = handleCalculateScore();
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                
                try {
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const margin = 40;
                    const contentWidth = pageWidth - 2 * margin;
                    let yPos = margin + 20;
                    
                    // Header
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(22);
                    pdf.text("Practice Session Report", pageWidth / 2, yPos, { align: "center" });
                    yPos += 30;

                    // Session Details
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(14);
                    pdf.text(`Session: ${sessionName}`, margin, yPos);
                    yPos += 20;
                    
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(11);
                    pdf.text(`Date: ${new Date().toLocaleString()}`, margin, yPos);
                    yPos += 15;
                    pdf.text(`Marking Scheme: +${positiveMarks} / -${negativeMarks}`, margin, yPos);
                    yPos += 25;

                    // Score Summary Box
                    pdf.setDrawColor(200);
                    pdf.setFillColor(245, 245, 245);
                    pdf.rect(margin, yPos, contentWidth, 60, 'F');
                    pdf.rect(margin, yPos, contentWidth, 60, 'S');
                    
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(16);
                    pdf.text(`Total Score: ${score}`, margin + 20, yPos + 35);
                    
                    pdf.setFontSize(11);
                    pdf.setFont("helvetica", "normal");
                    pdf.text(`Correct: ${correctCount}`, margin + 200, yPos + 25);
                    pdf.text(`Wrong: ${wrongCount}`, margin + 200, yPos + 45);
                    pdf.text(`Skipped/Unmarked: ${parseInt(numQuestions)-correctCount-wrongCount}`, margin + 300, yPos + 35);
                    
                    yPos += 90;

                    // Questions Table
                    const count = parseInt(numQuestions, 10) || 0;
                    
                    for (let i = 1; i <= count; i++) {
                        if (yPos > pdf.internal.pageSize.getHeight() - margin) {
                            pdf.addPage();
                            yPos = margin;
                        }

                        const status = reviewStatus[i] || 'unmarked';
                        const ans = questionType === 'mcq' 
                            ? (Array.isArray(answers[i]) && answers[i].length ? answers[i].join(', ') : 'None')
                            : (answers[i] || 'None');
                        const note = reviewNotes[i] || '-';

                        let color = [100, 100, 100]; // Grey
                        let statusText = "UNMARKED (0)";
                        
                        if (status === 'correct') {
                            color = [0, 100, 0]; // Green
                            statusText = `CORRECT (+${positiveMarks})`;
                        } else if (status === 'wrong') {
                            color = [200, 0, 0]; // Red
                            statusText = `WRONG (-${negativeMarks})`;
                        }

                        // Question Line
                        pdf.setFont("helvetica", "bold");
                        pdf.setFontSize(11);
                        pdf.setTextColor(0);
                        pdf.text(`Q${i}`, margin, yPos);
                        
                        pdf.setTextColor(color[0], color[1], color[2]);
                        pdf.text(statusText, margin + 40, yPos);
                        
                        pdf.setTextColor(0);
                        pdf.setFont("helvetica", "normal");
                        pdf.setFontSize(10);
                        const ansPrefix = "Your Answer: ";
                        const ansLines = pdf.splitTextToSize(ansPrefix + ans, contentWidth - 150);
                        pdf.text(ansLines, margin + 150, yPos);
                        
                        let extraHeight = (ansLines.length * 12);
                        if (note !== '-' && note.trim() !== '') {
                             pdf.setFont("helvetica", "italic");
                             pdf.setFontSize(9);
                             pdf.setTextColor(80);
                             const noteLines = pdf.splitTextToSize(`Note: ${note}`, contentWidth - 40);
                             pdf.text(noteLines, margin + 40, yPos + extraHeight);
                             extraHeight += (noteLines.length * 10);
                        }

                        yPos += extraHeight + 15;
                        pdf.setDrawColor(230);
                        pdf.line(margin, yPos - 5, pageWidth - margin, yPos - 5);
                    }

                    pdf.save(`Report_${sessionName.replace(/\s+/g, '_')}.pdf`);
                } catch (e) {
                    console.error(e);
                    showMessageBox("Failed to generate PDF.");
                }
            };

            // Utilities
            const showMessageBox = (html) => {
                const box = document.createElement('div');
                box.className = 'fixed inset-0 z-[2000] flex items-center justify-center modal-backdrop';
                box.innerHTML = `
                    <div class="modal-content p-8 rounded-lg text-center max-w-md mx-4">
                        <p class="text-xl font-semibold mb-4">${html}</p>
                        <button id="closeMsg" class="font-bold py-2 px-6 rounded-full transition-transform hover:scale-105" style="background-color: var(--accent-primary); color: var(--text-inverse);">OK</button>
                    </div>
                `;
                document.body.appendChild(box);
                document.getElementById('closeMsg').onclick = () => document.body.removeChild(box);
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            };
            const calculateFillPercentage = () => configuredDurationSeconds === 0 ? 100 : Math.max(0, Math.min(100, (timeLeftSeconds / configuredDurationSeconds) * 100));


            // --- Renderers ---
            
            const AccessibilityMenu = () => (
                <>
                    <button className="access-btn" onClick={() => setIsMenuOpen(!isMenuOpen)}> <IconSettings /> </button>
                    <div className={`access-menu ${isMenuOpen ? 'open' : ''}`}>
                        <div className="access-item" onClick={toggleTheme}>
                            <span className="flex items-center gap-2">{theme === 'light' ? <IconSun /> : <IconMoon />} Dark Mode</span>
                            <label className="toggle-switch"><input type="checkbox" checked={theme === 'dark'} onChange={toggleTheme} /><span className="slider"></span></label>
                        </div>
                    </div>
                </>
            );

            const renderQuestions = () => {
                const count = parseInt(numQuestions, 10);
                if (isNaN(count) || count <= 0) return null;
                
                const items = [];
                for(let i=1; i<=count; i++) {
                     items.push(
                         <div key={i} className="mb-4 p-4 rounded-xl shadow-sm transition-colors flex flex-col md:flex-row items-start md:items-center gap-4" 
                              style={{backgroundColor: 'var(--bg-element-alt)', borderLeft: '4px solid var(--accent-primary)'}}>
                             <div className="font-bold text-xl min-w-[40px]">Q{i}</div>
                             <div className="flex-grow">
                                 {questionType === 'mcq' ? (
                                     <div className="omr-container flex-wrap justify-start">
                                         {['A','B','C','D'].map(opt => {
                                             const isSelected = answers[i]?.includes(opt);
                                             return (
                                                 <div key={opt} 
                                                      onClick={() => handleAnswerChange(i, opt, true)}
                                                      className={`omr-bubble ${isSelected ? 'selected' : ''}`}>
                                                     {opt}
                                                 </div>
                                             );
                                         })}
                                     </div>
                                 ) : (
                                     <input type="text" placeholder="Type answer..." value={answers[i]||''} onChange={(e)=>handleAnswerChange(i, e.target.value)}
                                         className="w-full p-2 rounded border focus:outline-none focus:ring-2"
                                         style={{backgroundColor: 'var(--bg-element)', borderColor: 'var(--border-color)', color: 'var(--text-main)'}} />
                                 )}
                             </div>
                             <button onClick={()=>handleAnswerChange(i, questionType==='mcq'?[]:'', questionType==='mcq')} 
                                     className="text-xs px-3 py-1 rounded opacity-70 hover:opacity-100"
                                     style={{backgroundColor: 'var(--bg-element)', color: 'var(--text-main)'}}>Clear</button>
                         </div>
                     );
                }
                return items;
            };

            const renderReview = () => {
                const count = parseInt(numQuestions, 10);
                const items = [];
                for(let i=1; i<=count; i++) {
                    const status = reviewStatus[i];
                    const ansVal = questionType === 'mcq' ? (answers[i]||[]).join(', ') : answers[i];
                    const isAttempted = (Array.isArray(answers[i]) && answers[i].length > 0) || (!Array.isArray(answers[i]) && answers[i]);
                    const displayAns = isAttempted ? ansVal : 'Skipped';
                    
                    // Dynamic Background Logic
                    let bgColor = 'var(--bg-element-alt)';
                    let textColor = 'var(--text-main)';
                    
                    if (status === 'correct') {
                        bgColor = 'var(--bg-correct)';
                        textColor = 'var(--text-on-state)'; // Ensure readability on colored bg
                    } else if (status === 'wrong') {
                        bgColor = 'var(--bg-wrong)';
                        textColor = 'var(--text-on-state)';
                    }

                    items.push(
                        <div key={i} className="mb-4 p-4 rounded-lg shadow-sm transition-all duration-300"
                             style={{backgroundColor: bgColor, color: textColor}}>
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="font-bold text-lg">Question {i}</h4>
                                
                                {/* Conditional Buttons: Only show if attempted */}
                                {isAttempted ? (
                                    <div className="flex gap-4">
                                        <button onClick={()=>handleReviewMark(i, 'correct')} 
                                                className={`p-2 rounded-full transition-transform hover:scale-110 ${status==='correct'?'ring-2 ring-white ring-opacity-50':''}`}
                                                title="Mark Correct"
                                                style={{color: status === 'correct' ? textColor : 'var(--success-text)'}}>
                                            <IconCheck />
                                        </button>
                                        <button onClick={()=>handleReviewMark(i, 'wrong')}
                                                className={`p-2 rounded-full transition-transform hover:scale-110 ${status==='wrong'?'ring-2 ring-white ring-opacity-50':''}`}
                                                title="Mark Wrong"
                                                style={{color: status === 'wrong' ? textColor : 'var(--error-color)'}}>
                                            <IconCross />
                                        </button>
                                    </div>
                                ) : (
                                    <span className="text-sm italic opacity-60 border px-2 py-1 rounded border-current">Not Attempted</span>
                                )}
                            </div>
                            
                            <div className="flex flex-col gap-2">
                                <div className="text-base">
                                    <span className="opacity-80">Your Answer: </span>
                                    <span className="font-bold font-mono px-2 rounded" 
                                          style={{backgroundColor: 'rgba(0,0,0,0.1)'}}>
                                        {displayAns}
                                    </span>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Add a note..."
                                    value={reviewNotes[i]||''}
                                    onChange={(e)=>handleReviewNoteChange(i, e.target.value)}
                                    className="w-full text-sm p-2 rounded mt-1 bg-transparent border-b focus:outline-none focus:border-b-2 placeholder-current opacity-80 focus:opacity-100"
                                    style={{borderBottomColor: 'currentColor', color: 'inherit'}}
                                />
                            </div>
                        </div>
                    );
                }
                return items;
            };

            const handleReviewMark = (i, status) => {
                const newStatus = reviewStatus[i] === status ? 'unmarked' : status;
                setReviewStatus(prev => ({...prev, [i]: newStatus}));
            };
            const handleReviewNoteChange = (i, val) => setReviewNotes(prev => ({...prev, [i]: val}));


            // --- Main JSX ---
            return (
                <div className="min-h-screen flex flex-col items-center p-4 md:p-8 transition-colors duration-300">
                    <AccessibilityMenu />

                    {currentScreen === 'welcome' && (
                        <div className={`fixed inset-0 flex flex-col items-center justify-center p-6 z-50 ${isWelcomeFadingOut ? 'opacity-0 pointer-events-none' : ''}`}
                             style={{backgroundColor: 'var(--bg-card)', transition: 'opacity 1s'}}>
                            <h1 className="text-4xl md:text-6xl font-extrabold mb-6 text-center">OMR Practice Tool üìù</h1>
                            <p className="text-lg mb-8 text-center opacity-70">Master your exams with OMR-style practice.</p>
                            <button onClick={() => { setIsWelcomeFadingOut(true); setTimeout(()=>setCurrentScreen('config'), 1000); }}
                                className="font-bold py-4 px-12 rounded-full shadow-xl transform hover:scale-105 text-xl transition-all"
                                style={{backgroundColor: 'var(--accent-primary)', color: 'var(--text-inverse)'}}>
                                Start Session
                            </button>
                        </div>
                    )}

                    {currentScreen !== 'welcome' && currentScreen !== 'config' && (
                        <header className="w-full max-w-4xl shadow-lg rounded-2xl p-4 mb-6 text-center transition-colors" style={{backgroundColor: 'var(--bg-card)'}}>
                             <h2 className="text-2xl font-bold">
                                {currentScreen === 'practice' && "Mark Your Answers"}
                                {currentScreen === 'review' && "Review & Grade"}
                             </h2>
                        </header>
                    )}

                    {currentScreen === 'config' && (
                        <main className="w-full max-w-2xl shadow-xl rounded-2xl p-8 mb-8 flex flex-col gap-6 transition-colors animate-fade-in" 
                              style={{backgroundColor: 'var(--bg-card)'}}>
                            <div className="flex flex-col">
                                <label className="text-sm font-bold uppercase tracking-wide mb-1 opacity-70">Session Name</label>
                                <input type="text" placeholder="e.g., Physics Chapter 1" value={sessionName} onChange={(e)=>setSessionName(e.target.value)}
                                       className="text-2xl font-bold bg-transparent border-b-2 p-2 focus:outline-none focus:border-current"
                                       style={{borderColor: 'var(--border-color)', color: 'var(--accent-primary)'}} />
                            </div>

                            <div className="p-4 rounded-xl flex items-center gap-4" style={{backgroundColor: 'var(--bg-element-alt)'}}>
                                <span className="font-semibold whitespace-nowrap">Timer (min):</span>
                                <input type="number" min="1" value={timerMinutesInput} onChange={(e)=>setTimerMinutesInput(e.target.value)}
                                    className="p-2 rounded w-24 text-center font-mono"
                                    style={{backgroundColor: 'var(--bg-element)', color: 'var(--text-main)'}} />
                                <button onClick={handleSetTimer} className="text-sm font-bold px-4 py-2 rounded-full shadow"
                                    style={{backgroundColor: 'var(--accent-primary)', color: 'var(--text-inverse)'}}>Set</button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="flex flex-col p-3 rounded-lg" style={{backgroundColor: 'var(--bg-element)'}}>
                                    <label className="text-xs font-bold uppercase mb-1 opacity-70">Questions</label>
                                    <input type="number" min="1" max="180" value={numQuestions} onChange={(e)=>setNumQuestions(e.target.value)}
                                           className="bg-transparent text-xl font-bold focus:outline-none" style={{color: 'var(--text-main)'}} />
                                </div>
                                <div className="flex flex-col p-3 rounded-lg" style={{backgroundColor: 'var(--bg-element)'}}>
                                    <label className="text-xs font-bold uppercase mb-1 opacity-70">Correct (+)</label>
                                    <input type="number" min="1" value={positiveMarks} onChange={(e)=>setPositiveMarks(e.target.value)}
                                           className="bg-transparent text-xl font-bold focus:outline-none" style={{color: 'var(--accent-primary)'}} />
                                </div>
                                <div className="flex flex-col p-3 rounded-lg" style={{backgroundColor: 'var(--bg-element)'}}>
                                    <label className="text-xs font-bold uppercase mb-1 opacity-70">Wrong (-)</label>
                                    <input type="number" min="0" value={negativeMarks} onChange={(e)=>setNegativeMarks(e.target.value)}
                                           className="bg-transparent text-xl font-bold focus:outline-none" style={{color: 'var(--error-color)'}} />
                                </div>
                            </div>

                            <div className="flex gap-4 pt-2">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="qtype" value="mcq" checked={questionType==='mcq'} onChange={()=>setQuestionType('mcq')} className="accent-current" style={{color:'var(--accent-primary)'}}/>
                                    <span className="font-medium">OMR / MCQ</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="qtype" value="text" checked={questionType==='text'} onChange={()=>setQuestionType('text')} className="accent-current" style={{color:'var(--accent-primary)'}}/>
                                    <span className="font-medium">Text Input</span>
                                </label>
                            </div>

                            <button onClick={startPractice} className="mt-4 font-bold py-4 rounded-xl shadow-lg hover:scale-[1.02] transition-transform text-lg"
                                style={{backgroundColor: 'var(--accent-primary)', color: 'var(--text-inverse)'}}>
                                Start Practice Session
                            </button>
                        </main>
                    )}

                    {currentScreen === 'practice' && (
                        <>
                            <div
                                ref={timerRef}
                                className="draggable-timer p-4 shadow-2xl flex flex-col items-center justify-center text-2xl font-bold transition-colors duration-300"
                                onMouseDown={handleMouseDown}
                                style={{
                                    width: '160px',
                                    height: '70px',
                                    borderRadius: '9999px',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    backgroundColor: 'var(--timer-bg)',
                                    backgroundImage: `linear-gradient(to right, var(--timer-fill) ${calculateFillPercentage()}%, transparent ${calculateFillPercentage()}%)`,
                                    border: isRunning ? '4px solid var(--accent-primary)' : '4px solid var(--border-color)',
                                }}
                            >
                                <span className="text-xl timer-text">Time Left</span>
                                <span className="text-3xl timer-text">{formatTime(timeLeftSeconds)}</span>
                            </div>

                            <main className="w-full max-w-3xl shadow-xl rounded-2xl p-6 mb-8 transition-colors" style={{backgroundColor: 'var(--bg-card)'}}>
                                <div className="mb-4 pb-4 border-b border-opacity-20" style={{borderColor: 'var(--border-color)'}}>
                                    <h3 className="opacity-60 font-bold uppercase text-sm tracking-widest">{sessionName}</h3>
                                </div>
                                {renderQuestions()}
                                <div className="flex justify-center gap-4 mt-8 pt-6 border-t" style={{borderColor: 'var(--border-color)'}}>
                                    <button onClick={handleSubmitForReview} className="font-bold py-3 px-10 rounded-full shadow-lg transform hover:scale-105 transition-all"
                                        style={{backgroundColor: 'var(--accent-primary)', color: 'var(--text-inverse)'}}>
                                        Submit OMR Sheet
                                    </button>
                                    <button onClick={handleResetAll} className="font-bold py-3 px-6 rounded-full shadow transform hover:scale-105 transition-all opacity-80 hover:opacity-100"
                                        style={{backgroundColor: 'var(--bg-element)', color: 'var(--text-main)'}}>
                                        Reset
                                    </button>
                                </div>
                            </main>
                        </>
                    )}

                    {currentScreen === 'review' && (
                        <main className="w-full max-w-4xl shadow-xl rounded-2xl p-6 mb-8 transition-colors relative" style={{backgroundColor: 'var(--bg-card)'}}>
                            <div className="sticky top-0 z-10 py-2 mb-4 shadow-sm backdrop-blur-md bg-opacity-90 rounded-b-lg flex justify-between items-center px-4" 
                                 style={{backgroundColor: 'var(--bg-card)'}}>
                                <span className="font-bold opacity-70">Reviewing: {sessionName}</span>
                                <span className="text-xs">Mark attempted questions</span>
                            </div>
                            
                            {renderReview()}
                            
                            <div className="mt-8 p-6 rounded-xl text-center border-t-4" 
                                 style={{backgroundColor: 'var(--bg-element)', borderColor: 'var(--accent-primary)'}}>
                                <h3 className="text-2xl font-bold mb-4">Session Complete?</h3>
                                
                                {totalScore === null ? (
                                    <div className="flex flex-col items-center gap-4">
                                        <p className="opacity-70 max-w-md">Mark answers Correct (Green) or Wrong (Red). Unattempted questions cannot be marked.</p>
                                        <button onClick={handleCalculateScore} 
                                                className="font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all text-lg"
                                                style={{backgroundColor: 'var(--accent-primary)', color: 'var(--text-inverse)'}}>
                                            Calculate Score
                                        </button>
                                    </div>
                                ) : (
                                    <div className="animate-fade-in">
                                        <p className="text-sm uppercase tracking-widest opacity-60 mb-2">Final Score</p>
                                        <div className="text-6xl font-extrabold mb-6" style={{color: 'var(--accent-primary)'}}>
                                            {totalScore}
                                        </div>
                                        <div className="flex justify-center gap-4 flex-wrap">
                                            <button onClick={downloadReportCard} 
                                                    className="flex items-center gap-2 font-bold py-3 px-8 rounded-full shadow-xl hover:scale-105 transition-transform"
                                                    style={{backgroundColor: 'var(--text-main)', color: 'var(--bg-page)'}}>
                                                <span>Download Report PDF</span> <span>‚¨áÔ∏è</span>
                                            </button>
                                            <button onClick={handleResetAll} 
                                                    className="font-bold py-3 px-6 rounded-full shadow hover:scale-105 transition-transform border-2"
                                                    style={{borderColor: 'var(--accent-primary)', color: 'var(--text-main)'}}>
                                                Start New Session
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </main>
                    )}

                    <footer className="text-center text-xs opacity-50 mt-auto pb-4">
                        <p>&copy; {new Date().getFullYear()} OMR Practice Tool</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
